use csv::{Reader, Writer};
use rayon::prelude::*;
use serde::{Deserialize, Serialize};
use std::collections::HashMap;
use std::env;
use std::error::Error;

#[derive(Debug, Deserialize, Serialize, Clone)]
struct Record {
    title: String,
    text: String,
    subject: String,
    date: String,
}

/// Creates the MSA to Algerian Darija substitution map
fn create_substitution_map() -> HashMap<&'static str, &'static str> {
    HashMap::from([
        // Basic pronouns and question words
        ("أريد", "نحب"),
        ("أين", "وين"),
        ("ماذا", "واش"),
        ("كيف", "كيفاش"),
        ("لماذا", "علاه"),
        ("متى", "وقتاش"),
        ("كم", "شحال"),
        ("جداً", "بزاف"),
        ("الآن", "ضرك"),
        ("هذا", "هادا"),
        ("هذه", "هادي"),
        ("هناك", "لهيه"),
        ("لا يوجد", "ما كاينش"),
        ("يجب", "لازم"),
        ("من", "منين"),
        ("أي", "شكون"),
        ("هل", "واش"),
        // Pronouns
        ("نحن", "حنا"),
        ("هُم", "هوما"),
        ("أنتَ", "نتا"),
        ("أنتِ", "نتي"),
        ("أنتم", "نتوما"),
        ("هو", "هو"),
        ("هي", "هي"),
        // Verbs - Common actions
        ("أتكلم", "نهدر"),
        ("أذهب", "نروح"),
        ("أرجع", "نولي"),
        ("أعرف", "نعرف"),
        ("أفعل", "ندير"),
        ("أفهم", "نفهم"),
        ("أكل", "كلا"),
        ("شرب", "شرب"),
        ("نام", "رقد"),
        ("جلس", "قعد"),
        ("وقف", "وقف"),
        ("مشى", "مشى"),
        ("ركض", "جرى"),
        ("رأى", "شاف"),
        ("سمع", "سمع"),
        ("قال", "قال"),
        ("أخذ", "داه"),
        ("أعطى", "عطى"),
        ("جاء", "جا"),
        ("ذهب", "راح"),
        ("دخل", "دخل"),
        ("خرج", "خرج"),
        ("فتح", "حل"),
        ("أغلق", "سكر"),
        ("بحث", "قلب"),
        ("وجد", "لقى"),
        ("ضاع", "ضاع"),
        ("انتظر", "تسنى"),
        ("ساعد", "عاون"),
        ("عمل", "خدم"),
        ("لعب", "لعب"),
        ("ضحك", "ضحك"),
        ("بكى", "بكى"),
        ("نسي", "نسى"),
        ("تذكر", "تفكر"),
        ("فكر", "فكر"),
        ("حب", "حب"),
        ("كره", "كره"),
        // Quantities
        ("قليل", "شوية"),
        ("كثير", "بزاف"),
        ("كل", "كلش"),
        ("بعض", "شوية"),
        ("لا شيء", "والو"),
        ("فقط", "غير"),
        ("أيضاً", "زادة"),
        ("تقريباً", "تقريب"),
        // Nouns - Places
        ("بيت", "دار"),
        ("منزل", "دار"),
        ("غرفة", "بيت"),
        ("مطبخ", "كوزينة"),
        ("حمام", "بيت الما"),
        ("شارع", "زنقة"),
        ("سوق", "سوق"),
        ("مدرسة", "مدرسة"),
        ("مستشفى", "سبيطار"),
        ("صيدلية", "فارماسيان"),
        ("مقهى", "قهوة"),
        ("مطعم", "ريسطو"),
        // Nouns - Food
        ("طعام", "ماكلة"),
        ("خبز", "خبز"),
        ("ماء", "ما"),
        ("لحم", "لحم"),
        ("دجاج", "دجاج"),
        ("سمك", "حوت"),
        ("خضروات", "خضرة"),
        ("فواكه", "فاكية"),
        ("حليب", "حليب"),
        ("قهوة", "قهوة"),
        ("شاي", "أتاي"),
        // Nouns - People
        ("رجل", "راجل"),
        ("امرأة", "مرا"),
        ("طفل", "درّي"),
        ("أب", "باب"),
        ("أم", "يمّا"),
        ("أخ", "خو"),
        ("أخت", "خت"),
        ("جد", "جد"),
        ("جدة", "جدة"),
        ("عم", "عم"),
        ("خال", "خال"),
        // Nouns - Body
        ("رأس", "راس"),
        ("عين", "عين"),
        ("أذن", "ودن"),
        ("فم", "فم"),
        ("يد", "يد"),
        ("رجل", "رجل"),
        ("قلب", "قلب"),
        ("بطن", "كرش"),
        // Nouns - Objects
        ("سيارة", "طوموبيل"),
        ("هاتف", "تيليفون"),
        ("كتاب", "كتاب"),
        ("قلم", "ستيلو"),
        ("مفتاح", "سارو"),
        ("باب", "باب"),
        ("نافذة", "شرجم"),
        ("كرسي", "كرسي"),
        ("طاولة", "طابلة"),
        ("سرير", "ناموسية"),
        // Time
        ("غداً", "غدوة"),
        ("أمس", "البارح"),
        ("اليوم", "اليوم"),
        ("صباح", "صباح"),
        ("مساء", "العشية"),
        ("ليل", "ليل"),
        ("أسبوع", "سيمانة"),
        ("شهر", "شهر"),
        ("سنة", "عام"),
        ("ساعة", "ساعة"),
        ("دقيقة", "دقيقة"),
        ("بعد", "من بعد"),
        ("قبل", "قبل"),
        ("دائماً", "ديما"),
        ("أبداً", "عمرني"),
        ("أحياناً", "ساعات"),
        // Expressions
        ("شكراً", "صحيت"),
        ("عفواً", "بلا مزية"),
        ("مرحباً", "صحا"),
        ("وداعاً", "بسلامة"),
        ("صباح الخير", "صباح الخير"),
        ("مساء الخير", "مسا الخير"),
        ("تصبح على خير", "الله يمسيك بالخير"),
        ("كيف حالك", "لاباس"),
        ("بخير", "لاباس"),
        ("إن شاء الله", "إن شاء الله"),
        ("الحمد لله", "الحمد لله"),
        ("ما شاء الله", "ما شاء الله"),
        // Social
        ("صديق", "صاحب"),
        ("صديقة", "صاحبة"),
        ("جار", "جار"),
        ("زميل", "كوليغ"),
        // Adjectives
        ("جميل", "زين"),
        ("قبيح", "خايب"),
        ("كبير", "كبير"),
        ("صغير", "صغير"),
        ("طويل", "طويل"),
        ("قصير", "قصير"),
        ("جديد", "جديد"),
        ("قديم", "قديم"),
        ("سريع", "سريع"),
        ("بطيء", "بطيء"),
        ("حار", "سخون"),
        ("بارد", "بارد"),
        ("جيد", "مليح"),
        ("سيء", "خايب"),
        ("سهل", "ساهل"),
        ("صعب", "صعيب"),
        ("مشغول", "مشغول"),
        ("متعب", "عيان"),
        ("جائع", "فيه الجوع"),
        ("عطشان", "عطشان"),
        // Prepositions & Connectors
        ("في", "في"),
        ("على", "على"),
        ("من", "من"),
        ("إلى", "ل"),
        ("مع", "مع"),
        ("بدون", "بلا"),
        ("لكن", "بصح"),
        ("أو", "ولا"),
        ("و", "و"),
        ("لأن", "لخاطر"),
        ("إذا", "إذا"),
        ("عندما", "كي"),
        // Numbers (informal)
        ("واحد", "واحد"),
        ("اثنان", "زوج"),
        ("ثلاثة", "تلاتة"),
        ("أربعة", "ربعة"),
        ("خمسة", "خمسة"),
        ("عشرة", "عشرة"),
        ("مائة", "مية"),
        ("ألف", "ألف"),
        // Colors
        ("أبيض", "بيض"),
        ("أسود", "كحل"),
        ("أحمر", "حمر"),
        ("أخضر", "خضر"),
        ("أزرق", "زرق"),
        ("أصفر", "صفر"),
        // Weather
        ("شمس", "شمس"),
        ("مطر", "شتا"),
        ("ريح", "ريح"),
        ("حر", "صهد"),
        ("برد", "برد"),
        // Money & Shopping
        ("نقود", "دراهم"),
        ("ثمن", "سوم"),
        ("غالي", "غالي"),
        ("رخيص", "رخيص"),
        ("اشترى", "شرى"),
        ("باع", "باع"),
    ])
}


/// Transforms records in parallel, replacing MSA words with Darija equivalents
fn transform_to_darija(records: &mut [Record], map: &HashMap<&str, &str>) {
    records.par_iter_mut().for_each(|record| {
        for (msa, darija) in map.iter() {
            record.text = record.text.replace(msa, darija);
            record.title = record.title.replace(msa, darija);
        }
    });
}

fn main() -> Result<(), Box<dyn Error>> {
    let args: Vec<String> = env::args().collect();
    if args.len() < 2 {
        eprintln!("Usage: {} <input.csv>", args[0]);
        std::process::exit(1);
    }

    let input_path = &args[1];
    // Output: alg01.csv, alg02.csv, etc based on input file number
    let output_path = if let Some(num) = extract_number(input_path) {
        format!("alg{:02}.csv", num)
    } else {
        format!("alg_{}.csv", input_path.trim_end_matches(".csv"))
    };

    let substitution_map = create_substitution_map();

    // Read CSV records
    let mut reader = Reader::from_path(input_path)?;
    let mut records: Vec<Record> = reader
        .deserialize()
        .filter_map(Result::ok)
        .collect();

    if records.is_empty() {
        println!("No records found in {}", input_path);
        return Ok(());
    }

    println!("Read {} records. Transforming...", records.len());

    // Parallel transformation
    transform_to_darija(&mut records, &substitution_map);

    // Write output
    let mut writer = Writer::from_path(&output_path)?;
    for record in records {
        writer.serialize(record)?;
    }
    writer.flush()?;

    println!("Saved to {}", output_path);
    Ok(())
}

/// Extract number from filename like "true_clean_translated_done_01.csv" -> 1
fn extract_number(filename: &str) -> Option<u32> {
    filename
        .chars()
        .filter(|c| c.is_ascii_digit())
        .collect::<String>()
        .parse()
        .ok()
}
